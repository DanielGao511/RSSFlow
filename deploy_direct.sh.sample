#!/bin/bash

# ================= é…ç½®åŒº =================
SERVER_IP="åœ¨è¿™é‡Œå¡«å…¥ä½ çš„æœåŠ¡å™¨ IP"
SERVER_USER="root"
TARGET_DIR="/root/rss-deploy"
# =========================================

echo "ğŸš€ [1/5] å¼€å§‹æœ¬åœ°æ„å»º (å¼ºåˆ¶ Linux æ¶æ„)..."

# 1. æ„å»º RSSHub
docker build --platform linux/amd64 -t custom-rsshub:latest ./rsshub

# 2. æ„å»º AI-Bridge
docker build --platform linux/amd64 -t custom-ai-bridge:latest ./ai-bridge

echo "ğŸ“¦ [2/5] æ­£åœ¨æ‰“åŒ…é•œåƒ (è¿™å¯èƒ½éœ€è¦å‡ ç§’é’Ÿ)..."
# åªæ‰“åŒ…è¿™ä¸¤ä¸ªè‡ªå®šä¹‰é•œåƒï¼ŒBot å’Œ Redis è®©æœåŠ¡å™¨è‡ªå·±æ‹‰å–ï¼ŒèŠ‚çœä¸Šä¼ æµé‡
docker save -o deploy_images.tar custom-rsshub:latest custom-ai-bridge:latest

echo "ğŸ“¡ [3/5] æ­£åœ¨ä¸Šä¼ æ–‡ä»¶åˆ°æœåŠ¡å™¨ ($SERVER_IP)..."
# åˆ›å»ºè¿œç¨‹ç›®å½•
ssh $SERVER_USER@$SERVER_IP "mkdir -p $TARGET_DIR"
# ä¸Šä¼ : é•œåƒåŒ… + é…ç½®æ–‡ä»¶ + ç¯å¢ƒå˜é‡
scp deploy_images.tar docker-compose.prod.yml .env $SERVER_USER@$SERVER_IP:$TARGET_DIR/

echo "ğŸ”§ [4/5] æ­£åœ¨æœåŠ¡å™¨ä¸Šè§£åŒ…å¹¶éƒ¨ç½²..."
ssh $SERVER_USER@$SERVER_IP "
  cd $TARGET_DIR && \
  mv docker-compose.prod.yml docker-compose.yml && \
  echo 'æ­£åœ¨å¯¼å…¥é•œåƒ...' && \
  docker load -i deploy_images.tar && \
  echo 'æ­£åœ¨å¯åŠ¨æœåŠ¡...' && \
  docker compose up -d && \
  echo 'æ¸…ç†ä¸´æ—¶æ–‡ä»¶...' && \
  rm deploy_images.tar
"

echo "ğŸ§¹ [5/5] æ¸…ç†æœ¬åœ°ä¸´æ—¶æ–‡ä»¶..."
rm deploy_images.tar

echo "ğŸ‰ éƒ¨ç½²æˆåŠŸï¼æ‰€æœ‰æœåŠ¡å·²åœ¨çº¿ä¸Šè¿è¡Œã€‚"